#!/usr/bin/env python

import optparse
import logging
import string
import sys

# Temporarily set the path for testing
sys.path.append("../")

from mctl.config import Config
from mctl.server import Server

parser = optparse.OptionParser(
    usage       = "usage: %prog [OPTIONS]",
    description = "Minecraft server controller"
)

acts  = optparse.OptionGroup(parser, "Server Actions")
attrs = optparse.OptionGroup(parser, "Server Attributes")

parser.add_option(
    "-g", "--config",
    action  = "store",
    dest    = "config",
    metavar = "PATH",
    help    = "specify a nonstandard config file"
)
parser.add_option(
    "-s", "--server",
    action  = "store",
    dest    = "server",
    metavar = "SERVER",
    help    = "server to apply actions and attributes to"
)
parser.add_option(
    "-l", "--list",
    action  = "store_true",
    dest    = "list",
    help    = "list the current servers"
)
parser.add_option(
    "-f", "--force",
    action  = "store_true",
    dest    = "force",
    help    = "force specified actions"
)
parser.add_option(
    "-d", "--dry-run",
    action  = "store_true",
    dest    = "dryrun",
    help    = "run on a trial basis; do not modify packages"
)

acts.add_option(
    "-a", "--archive",
    action  = "store_true",
    dest    = "archive",
    help    = "archive the server archive paths"
)
acts.add_option(
    "-u", "--upgrade",
    action  = "store_true",
    dest    = "upgrade",
    help    = "upgrade the server packages"
)
acts.add_option(
    "-i", "--start",
    action  = "store_true",
    dest    = "start",
    help    = "start the sever"
)
acts.add_option(
    "-q", "--stop",
    action  = "store_true",
    dest    = "stop",
    help    = "stop the sever"
)
acts.add_option(
    "-r", "--restart",
    action  = "store_true",
    dest    = "restart",
    help    = "restart the sever"
)
acts.add_option(
    "-c", "--command",
    action  = "store",
    dest    = "command",
    metavar = "COMMAND",
    help    = "run a command on the server"
)

attrs.add_option(
    "--include",
    action  = "store",
    dest    = "include",
    metavar = "LIST",
    help    = "list archives or packages to include"
)
attrs.add_option(
    "--exclude",
    action  = "store",
    dest    = "exclude",
    metavar = "LIST",
    help    = "list archives or packages to exclude"
)
attrs.add_option(
    "--message",
    action  = "store",
    dest    = "message",
    metavar = "MESSAGE",
    help    = "message for restart/stop"
)
attrs.add_option(
    "--timeout",
    action  = "store",
    dest    = "timeout",
    metavar = "TIMEOUT",
    help    = "server shutdown timeout in seconds"
)

parser.add_option_group(acts)
parser.add_option_group(attrs)

opts, args = parser.parse_args()

logging.basicConfig(format = "[%(levelname)s] %(message)s")

config = Config(opts.config)
log    = logging.getLogger("mctl")

log.setLevel(logging.INFO)

config.load()

server  = None
package = None

if opts.list:
    servers = config.servers_get()
    servers = servers.keys()

    if len(servers) < 1:
        print "No servers found"

    print "Server(s): %s" % (string.join(servers, ", "))
    exit()

if not opts.server:
    parser.error("option -s, --server is required")

if not config.server_exists(opts.server):
    parser.error("option -s, --server requires a valid server")

server = config.server_get(opts.server)

if opts.timeout:
    server['timeout'] = int(opts.timeout)

config.server_set(opts.server, server)
server = Server(opts.server, server)

if opts.restart:
    opts.stop = opts.start = True

if opts.archive:
    server.archive(opts.include, opts.exclude)

if opts.stop:
    server.stop(opts.message)

if opts.upgrade:
    server.upgrade(config, opts.force, opts.include, opts.exclude, opts.dryrun)

if opts.start:
    server.start(opts.force)

if opts.command:
    server.command(opts.command)
